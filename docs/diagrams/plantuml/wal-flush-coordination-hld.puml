@startuml WAL_Flush_Coordination_HLD
skinparam backgroundColor #FEFEFE
skinparam component {
    BackgroundColor<<wal>> LightBlue
    BackgroundColor<<memtable>> LightGreen
    BackgroundColor<<disk>> LightGray
    BackgroundColor<<storage>> LightCoral
    BackgroundColor<<coordinator>> Gold
}

title WAL Flush Coordination - High Level Design
header ProximaDB Vector Database
footer Generated with PlantUML

package "WAL Subsystem" 
    component "WAL Strategy\n(Base Trait)" as WalStrategy <<wal>>
    
    package "Memory Layer" 
        component "MemTable Strategy" as MemTable <<memtable>>
        component "BTree\nMemTable" as BTree <<memtable>>
        component "HashMap\nMemTable" as HashMap <<memtable>>
        component "SkipList\nMemTable" as SkipList <<memtable>>
        component "ART\nMemTable" as ART <<memtable>>
    }
    
    package "Disk Layer" 
        component "Disk Manager" as DiskManager <<disk>>
        component "Avro\nSerializer" as Avro <<disk>>
        component "Bincode\nSerializer" as Bincode <<disk>>
    }
    
    component "Flush\nCoordinator" as FlushCoordinator <<coordinator>>
}

package "Storage Engines" 
    component "LSM Tree\nStorage" as LSM <<storage>>
    component "VIPER\nStorage" as VIPER <<storage>>
}

' Strategy Relationships
WalStrategy --> MemTable : "owns"
WalStrategy --> DiskManager : "owns"
WalStrategy --> FlushCoordinator : "uses"

' Concrete Implementations
MemTable <|-- BTree : "ordered"
MemTable <|-- HashMap : "O(1) ops"
MemTable <|-- SkipList : "probabilistic"
MemTable <|-- ART : "space-efficient"

DiskManager --> Avro : "schema evolution"
DiskManager --> Bincode : "performance"

' Flush Flow
FlushCoordinator ..> LSM : "flush to\nSSTables"
FlushCoordinator ..> VIPER : "flush to\nParquet"

' Optimal Pairings
BTree ..> LSM : "best for\nordered flush"
SkipList ..> LSM : "good for\nconcurrent"
HashMap ..> VIPER : "best for\nrandom access"
ART ..> VIPER : "best for\nsparse data"

' Flush Triggers
cloud "Flush Triggers" as Triggers 
    card "Memory\nThreshold" as MemTrigger
    card "Disk\nThreshold" as DiskTrigger
    card "Time\nThreshold" as TimeTrigger
}

Triggers --> FlushCoordinator : "triggers"

@enduml